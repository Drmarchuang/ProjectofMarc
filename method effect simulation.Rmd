---
title: "method effect simulation"
output: html_notebook
---

import libraries

```{r}
library(simsem)
library(lavaan)
source('https://raw.githubusercontent.com/MaksimRudnev/AlignmentMplusAutomation/master/source_repo.R')
```

randomness
```{r}
set.seed(1)
```

models to test
```{r}
no.meth <- 'constr =~ y1 + y2 +y3 + y4 + y5 + y6'
meth <- 'constr =~ y1 + y2 +y3 + y4 + y5 + y6
         meth =~ y4 + y5 + y6
        meth ~~ 0*constr'
meth.cor <- 'constr =~ y1 + y2 +y3 + y4 + y5 + y6
            y4 ~~ y5 + y6
            y5 ~y6'
```



1. data with no method effect
generate matrix for six obserable variables
```{r}
loadings.1 <- matrix(NA,6,1)
loadVal.1 <- matrix(.7,6,1)
LY.1 <- bind(loadings.1, loadVal.1)
error.cov.1 <- matrix(0,6,6)
diag(error.cov.1) <- 1
RTE.1 <- binds(error.cov.1)
latent.cov.1 <- as.matrix(1)
RPS.1 <- binds(latent.cov.1)
itcp.mean.1 <- rep(NA,6)
TY.1 = bind(itcp.mean.1,3)
model.1 <- model(LY=LY.1, RPS = RPS.1, RTE= RTE.1, TY=TY.1, modelType = 'CFA', indLab=c('y1','y2','y3','y4','y5','y6'), facLab = 'constr')
```

generate data
```{r}
dat <- generate(model.1, 200)
```

1.2. analyze data with lavaan
without method effect
```{r}
fit <- cfa(no.meth, data = dat, meanstructure = T)
summary(fit, fit.measures=T)
```

with method effect
```{r}
fit <- cfa(meth, data = dat, meanstructure = T)
summary(fit, fit.measures=T)
```


extract information
```{r}
para <- parameterestimates(fit)
constr <- para[which(para$lhs =='constr'& para$op== '~1'),]$est
```



2 testing model with random method effect
```{r}
loading.2 <- matrix(0,6,2)
loading.2[1:6,1] <- NA
loading.2[4:6,2] <- NA
loadVal.2 <- matrix(0,6,2)
loadVal.2[1:6,1] <- .7
loadVal.2[4:6,2] <- 'runif(1,sqrt(.01),sqrt(.3))' # random method factor loadings
LY.2 = bind(loading.2, loadVal.2)
latent.cov.2 <- matrix(0,2,2)
diag(latent.cov.2) <- NA
RPS.2 <- binds(latent.cov.2,1)
error.cov.2 <- matrix(0,6,6)
diag(error.cov.2) <- 1
RTE.2 <- binds(error.cov.2)
itcp.mean.2 <- rep(NA,6)
TY.2 = bind(itcp.mean.2,3)
factor.mean.2 <- c(NA,NA)
AL.2 <- bind(factor.mean.2,c(1,'runif(1,-1,1)')) # random method effect
model.2 <- model(LY=LY.2, RPS = RPS.2, RTE= RTE.2, TY=TY.2, AL= AL.2, modelType = 'CFA', indLab=c('y1','y2','y3','y4','y5','y6'), facLab = c('constr', 'meth'))
```


2.1generate data
```{r}
dat <- generate(model.2, 200)
```

2.2 analysis with lavaan
```{r}
fit <- cfa(meth, data = dat)
summary(fit, fit.measures=T)
```


3. two group simulation

set one group factor mean as 0 and the other as 1
```{r}
# all idental but the factor mean
loading.3 <- matrix(0,6,2)
loading.3[1:6,1] <- NA
loading.3[4:6,2] <- NA
loadVal.3 <- matrix(0,6,2)
loadVal.3[1:6,1] <- .7
loadVal.3[4:6,2] <- 'runif(3,sqrt(.01), sqrt(.03))'
LY.3 <- bind(loading.3, loadVal.3)
latent.cov.3 <- matrix(0,2,2)
diag(latent.cov.3) <- NA
RPS.3 <- binds(latent.cov.3,1)
error.cov.3 <- matrix(0,6,6)
diag(error.cov.3) <- 1
RTE.3 <- binds(error.cov.3)
itcp.mean.3 <- rep(NA,6)
TY.3 = bind(itcp.mean.3,3)
# CN group
factor.mean.CN <- c(NA,NA)
AL.CN <- bind(factor.mean.CN,c(0,'runif(1,-1,1)'))
# US group
factor.mean.US <- c(NA,NA)
AL.US <- bind(factor.mean.US,c(1,'runif(1,-1,1)'))
model.CN <- model(LY=LY.3, RPS = RPS.3, RTE= RTE.3, TY=TY.3, AL= AL.CN, modelType = 'CFA', indLab=c('y1','y2','y3','y4','y5','y6'), facLab = c('constr', 'meth'))
model.US <- model(LY=LY.3, RPS = RPS.3, RTE= RTE.3, TY=TY.3, AL= AL.US, modelType = 'CFA', indLab=c('y1','y2','y3','y4','y5','y6'), facLab = c('constr', 'meth'))
```

3.1 data generation
```{r}
data.CN <- generate(model.CN,200)
data.US <- generate(model.US,200)
```

3.2 conbination
```{r}
data.CN$nation <- 1
data.US$nation <- 2
all.data <- rbind(data.CN, data.US)
```

3.3 analysis with lavaan
```{r}
fit <- cfa(meth, data = all.data, group= 'nation',
           group.equal= c('loadings','intercepts'),
           group.partial = c('meth =~ y4','meth =~ y5','meth =~ y6'),
           meanstructure = T)
summary(fit)
```




























































